<style>
  .safe-bottom {
    padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
  }

  /* ✅ Medida única para toda la app */
  .app-shell {
    padding-left: 6px;
    padding-right: 6px;
    padding-top: 0px;
    padding-bottom: 0px;
  }

  @media (min-width: 640px) {
    .app-shell {
      padding-left: 12px;
      padding-right: 12px;
    }
  }

  @media (min-width: 768px) {
    .app-shell {
      padding-left: 16px;
      padding-right: 16px;
    }
  }
</style>

<div class="flex items-start justify-center min-h-[calc(100vh-200px)] app-shell py-0 sm:py-5">
  <div class="w-full max-w-full sm:max-w-5xl lg:max-w-7xl xl:max-w-screen-xl mx-auto
           bg-gradient-to-br from-slate-900/95 via-slate-900/90 to-slate-950/95
           backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700/80
           px-4 sm:px-6 md:px-10 py-6 sm:py-8 md:py-10 text-white safe-bottom overflow-x-hidden">

    <!-- Header -->
    <header class="mb-5 sm:mb-7">
      <p class="text-xs sm:text-sm uppercase tracking-[0.25em] text-slate-400 mb-2">
        Cliente · Panel
      </p>

      <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold tracking-tight">
        Bienvenido, <span class="text-sky-300"><%= cliente.nombre %> <%= cliente.apellido %></span>
      </h1>

      <p class="text-sm sm:text-base text-slate-300 mt-2 max-w-2xl">
        Tus datos personales y el detalle de tus facturas con pagos asociados.
      </p>
    </header>

    <!-- ✅ Datos personales (más compacto + 2 columnas en mobile) -->
    <section class="mb-6 sm:mb-8">
      <h2 class="text-base sm:text-lg font-semibold text-white mb-2 sm:mb-3">
        Datos personales
      </h2>

      <div class="bg-slate-900/60 border border-slate-700/80 rounded-2xl p-3 sm:p-5 shadow">
        <!-- ✅ Grid compacto: 2 columnas desde mobile -->
        <dl class="grid grid-cols-2 gap-2 sm:gap-3">
          <!-- DNI -->
          <div class="bg-slate-950/25 border border-slate-700/70 rounded-xl p-2.5 sm:p-4">
            <dt class="text-[10px] uppercase tracking-wide text-slate-400">DNI</dt>
            <dd class="text-white font-semibold mt-0.5 text-sm sm:text-base"><%= cliente.dni || "—" %></dd>
          </div>

          <!-- Teléfono -->
          <div class="bg-slate-950/25 border border-slate-700/70 rounded-xl p-2.5 sm:p-4">
            <dt class="text-[10px] uppercase tracking-wide text-slate-400">Teléfono</dt>
            <dd class="text-white font-semibold mt-0.5 text-sm sm:text-base"><%= cliente.telefono || "—" %></dd>
          </div>

          <!-- Email (full width) -->
          <div class="col-span-2 bg-slate-950/25 border border-slate-700/70 rounded-xl p-2.5 sm:p-4">
            <dt class="text-[10px] uppercase tracking-wide text-slate-400">Email</dt>
            <dd class="text-white font-semibold mt-0.5 text-sm sm:text-base break-words"><%= cliente.email || "—" %></dd>
          </div>

          <!-- Dirección (full width) -->
          <div class="col-span-2 bg-slate-950/25 border border-slate-700/70 rounded-xl p-2.5 sm:p-4">
            <dt class="text-[10px] uppercase tracking-wide text-slate-400">Dirección</dt>
            <dd class="text-white font-semibold mt-0.5 text-sm sm:text-base"><%= cliente.direccion || "—" %></dd>
          </div>

          <!-- Plan (full width, más compacto) -->
          <div class="col-span-2 bg-slate-950/25 border border-slate-700/70 rounded-xl p-2.5 sm:p-4">
            <dt class="text-[10px] uppercase tracking-wide text-slate-400">Plan</dt>
            <dd class="mt-1 flex items-start justify-between gap-3">
              <div class="min-w-0">
                <p class="text-white font-semibold text-sm sm:text-base truncate">
                  <%= cliente.plan?.nombre || "—" %>
                </p>
                <p class="text-xs text-slate-400 mt-0.5">
                  Servicio contratado
                </p>
              </div>

              <p class="shrink-0 text-sm sm:text-base text-emerald-300 font-extrabold">
                <%= cliente.plan?.precioFormateado || (cliente.plan?.precio != null ?
                  Number(cliente.plan.precio).toLocaleString("es-AR", { style:"currency", currency:"ARS" }) : "" ) %>
              </p>
            </dd>
          </div>
        </dl>
      </div>
    </section>

    <!-- Facturas + pagos asociados -->
    <section>
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-3 mb-3 sm:mb-4">
        <div>
          <h2 class="text-base sm:text-lg font-semibold text-white">
            Facturas y pagos asociados
          </h2>
          <!-- <p class="text-xs sm:text-sm text-slate-400 mt-1">
            Cada tarjeta es una factura. Adentro se ven sus pagos (con recibo).
          </p> -->
        </div>

        <%
          const _facturas = (facturasUI || []).slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
          const fmtARS = (n) => Number(n || 0).toLocaleString("es-AR", { style:"currency", currency:"ARS" });

          const totalFacturado = _facturas.reduce((acc, f) => acc + Number(f.cargo || 0), 0);
          const totalPagado = _facturas.reduce((acc, f) => {
            const pagosLocal = (f.pagos || f.pagosAsociados || f.pagosFactura || []);
            return acc + pagosLocal.reduce((a,p)=> a + Number(p.importe || 0), 0);
          }, 0);

          const totalAdeudado = Math.max(0, totalFacturado - totalPagado);
          const estaAlDia = Number(totalAdeudado) <= 0;
        %>

        <!-- Totales -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3 w-full lg:w-auto">
          <!-- <div class="bg-slate-900/55 border border-slate-700/70 rounded-2xl p-3 shadow">
            <p class="text-[11px] uppercase tracking-wide text-slate-400">Facturado</p>
            <p class="text-base sm:text-lg font-extrabold text-rose-300 mt-1"><%= fmtARS(totalFacturado) %></p>
          </div>

          <div class="bg-slate-900/55 border border-slate-700/70 rounded-2xl p-3 shadow">
            <p class="text-[11px] uppercase tracking-wide text-slate-400">Pagado</p>
            <p class="text-base sm:text-lg font-extrabold text-emerald-300 mt-1"><%= fmtARS(totalPagado) %></p>
          </div> -->

          <% if (estaAlDia) { %>
            <!-- ✅ Cartel "Estás al día" -->
            <div class="bg-slate-900/55 border border-emerald-500/45 rounded-2xl p-3 shadow">
              <p class="text-[11px] uppercase tracking-wide text-slate-400">Estado</p>
              <div class="mt-1 flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-emerald-500/15 border border-emerald-400/30 text-emerald-200 text-sm">
                  ✓
                </span>
                <p class="text-base sm:text-lg font-extrabold text-emerald-300 leading-tight">
                  Estás al día
                </p>
              </div>
              <p class="text-[11px] text-slate-400 mt-1">
                No tenés saldos pendientes de pago.
              </p>
            </div>
          <% } else { %>
            <!-- ✅ Cartel "Adeudado" -->
            <div class="bg-slate-900/55 border border-red-500/50 rounded-2xl p-3 shadow">
              <p class="text-[11px] uppercase tracking-wide text-slate-400">Adeudado</p>
              <p class="text-base sm:text-lg font-extrabold text-red-400 mt-1"><%= fmtARS(totalAdeudado) %></p>
              <p class="text-[11px] text-slate-400 mt-1">
                Tenés saldo pendiente.
              </p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- ✅ BOTÓN SIEMPRE debajo del recuadro (al día o adeudado) -->
      <% if (_facturas.length) { %>
        <div class="mt-2 flex justify-end items-center">
          <button
            id="btnToggleHistorial"
            type="button"
            class="inline-flex items-center justify-center
                   bg-sky-500/15 hover:bg-sky-500/25
                   border border-sky-400/25
                   text-sky-200 font-medium
                   px-4 py-2 rounded-lg transition text-xs"
          >
            Ver todas las facturas
          </button>
        </div>
      <% } %>

      <% if (!_facturas.length) { %>
        <div class="bg-slate-900/40 border border-slate-700/70 rounded-2xl p-6 text-center mt-4">
          <p class="text-slate-200 font-semibold">Sin facturas aún.</p>
          <p class="text-slate-400 text-sm mt-1">Cuando existan cargos, aparecerán aquí.</p>
        </div>
      <% } else { %>

        <!-- Cards compactas -->
        <div id="facturasList" class="mt-4 space-y-2 sm:space-y-3">
          <% _facturas.forEach((f)=> {
            const pagosRaw = (f.pagos || f.pagosAsociados || f.pagosFactura || []);
            const pagos = pagosRaw.slice().sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

            const totalPagosFactura = pagos.reduce((acc, p) => acc + Number(p.importe || 0), 0);
            const pendiente = Math.max(0, Number(f.cargo || 0) - totalPagosFactura);
          %>

            <article
              class="factura-card bg-slate-900/55 border border-red-500/50 rounded-xl p-3 sm:p-4 shadow"
              data-pendiente="<%= Number(pendiente || 0) %>"
            >
              <!-- Header factura -->
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="text-[11px] text-slate-400">
                    <%= new Date(f.fecha).toLocaleDateString("es-AR") %>
                    <span class="mx-2 text-slate-600">•</span>
                    Factura Nº <span class="text-white font-semibold"><%= f.numero %></span>
                  </p>
                  <p class="text-sm text-slate-200 mt-1 truncate">
                    <%= f.detalle || "—" %>
                  </p>
                </div>

                <div class="shrink-0 text-right">
                  <p class="text-[11px] text-slate-400">Factura</p>
                  <p class="text-base sm:text-lg font-extrabold text-red-400 leading-tight">
                    <%= fmtARS(f.cargo) %>
                  </p>
                  <p class="text-[11px] text-slate-400 mt-1">
                    Pendiente:
                    <span class="<%= pendiente > 0 ? 'text-red-400 font-semibold' : 'text-emerald-200 font-semibold' %>">
                      <%= fmtARS(pendiente) %>
                    </span>
                  </p>
                </div>
              </div>

              <!-- Pagos adentro -->
              <div class="mt-3 border-t border-slate-700/70 pt-3">
                <div class="flex items-center justify-between gap-3">
                  <p class="text-xs font-semibold text-slate-200">Pagos</p>

                  <% if (pagos.length) { %>
                    <p class="text-xs font-bold text-emerald-300 whitespace-nowrap">
                      + <%= fmtARS(totalPagosFactura) %>
                    </p>
                  <% } else { %>
                    <p class="text-xs text-slate-500">Sin pagos</p>
                  <% } %>
                </div>

                <% if (pagos.length) { %>
                  <div class="mt-2 space-y-2">
                    <% pagos.forEach((p)=> { %>
                      <div class="bg-slate-950/40 border border-emerald-400/15 rounded-lg p-2.5">
                        <div class="flex items-center justify-between gap-3">
                          <div class="min-w-0">
                            <p class="text-[11px] text-slate-400 truncate">
                              <%= new Date(p.fecha).toLocaleDateString("es-AR") %>
                              <span class="mx-2 text-slate-600">•</span>
                              Recibo Nº <span class="text-white font-semibold"><%= p.numero || "—" %></span>
                            </p>
                          </div>

                          <div class="flex items-center gap-2 shrink-0">
                            <!-- <p class="text-xs font-bold text-emerald-300 whitespace-nowrap">
                              + <%= fmtARS(p.importe) %>
                            </p> -->

                            <% if (p._id) { %>
                              <a
                                href="/cobros/<%= p._id %>/recibo"
                                class="inline-flex items-center justify-center
                                       bg-sky-500/15 hover:bg-sky-500/25
                                       border border-sky-400/25
                                       text-sky-200 font-semibold
                                       px-2.5 py-1 rounded-lg transition text-[11px] whitespace-nowrap"
                              >
                                Ver recibo
                              </a>
                            <% } %>
                          </div>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                <% } %>
              </div>

              <% if (!pagos.length) { %>
                <p class="text-xs text-slate-400 mt-2">
                  Aún no hay pagos registrados para esta factura.
                </p>
              <% } %>
            </article>

          <% }) %>
        </div>

        <!-- ✅ LÓGICA NUEVA (SIN rutas): 
            - Si debe: muestra SOLO impagas al cargar
            - Si está al día: no muestra nada al cargar (porque no hay impagas), y el botón muestra todas -->
        <script>
          (function () {
            const btn = document.getElementById("btnToggleHistorial");
            const cards = Array.from(document.querySelectorAll(".factura-card"));
            if (!btn || !cards.length) return;

            const impagas = [];
            const pagadas = [];

            cards.forEach(card => {
              const pendiente = Number(card.dataset.pendiente || 0);
              if (pendiente > 0) impagas.push(card);
              else pagadas.push(card);
            });

            const estaAlDia = impagas.length === 0;

            // helpers
            const show = (arr) => arr.forEach(c => c.classList.remove("hidden"));
            const hide = (arr) => arr.forEach(c => c.classList.add("hidden"));

            // Estado inicial
            // - Si debe: mostrar TODAS las impagas y ocultar todas las pagadas
            // - Si al día: ocultar TODO (porque son todas pagadas)
            if (estaAlDia) {
              hide(cards);
              btn.textContent = "Ver todo";
            } else {
              show(impagas);
              hide(pagadas);
              btn.textContent = "Ver todo";
            }

            let expanded = false;

            btn.addEventListener("click", () => {
              expanded = !expanded;

              if (expanded) {
                // mostrar todo
                show(cards);
                btn.textContent = "Ocultar todo";
              } else {
                // volver al estado inicial
                if (estaAlDia) {
                  hide(cards);
                  btn.textContent = "Ver todo";
                } else {
                  show(impagas);
                  hide(pagadas);
                  btn.textContent = "Ver todo";
                }
              }
            });
          })();
        </script>

      <% } %>
    </section>

  </div>
</div>
