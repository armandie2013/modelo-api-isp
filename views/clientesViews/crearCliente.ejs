<main>
  <style>
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 16px); }
  </style>

  <!-- ✅ MISMO WRAPPER QUE ADMIN -->
  <div class="flex items-start justify-center min-h-[calc(100vh-200px)] px-2 sm:px-4 py-0 sm:py-5">
    <div
      class="w-full max-w-full sm:max-w-5xl lg:max-w-7xl xl:max-w-screen-xl mx-auto
             bg-gradient-to-br from-slate-900/95 via-slate-900/90 to-slate-950/95
             backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700/80
             px-4 sm:px-6 md:px-10 py-6 sm:py-8 md:py-10 text-white safe-bottom"
    >

      <!-- Header -->
      <header class="mb-8">
        <p class="text-xs uppercase tracking-widest text-slate-400 mb-2">
          Administración · Clientes
        </p>
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
          Registrar nuevo cliente
        </h1>
        <p class="text-sm text-slate-300 mt-1 max-w-2xl">
          Completá los datos del cliente y asignale un plan. El DNI debe tener 8 dígitos.
        </p>
      </header>

      <!-- Card -->
      <div class="flex justify-center">
        <div class="w-full max-w-2xl bg-slate-800/70 border border-slate-600/70 rounded-2xl p-6 sm:p-8 shadow-lg">

          <!-- Errores -->
          <% if (errores && errores.length) { %>
            <div class="mb-5 rounded-xl border border-rose-400/40 bg-rose-500/10 px-4 py-3 text-rose-200 text-sm">
              <% errores.forEach(error => { %>
                <p>• <%= error %></p>
              <% }) %>
            </div>
          <% } %>

          <form action="/clientes/crear" method="POST" class="space-y-6" onsubmit="return validarFormulario()">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

              <!-- Nombre -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">Nombre</label>
                <input
                  type="text"
                  name="nombre"
                  id="nombre"
                  placeholder="Nombre"
                  required
                  value="<%= datos?.nombre || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
              </div>

              <!-- Apellido -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">Apellido</label>
                <input
                  type="text"
                  name="apellido"
                  id="apellido"
                  placeholder="Apellido"
                  required
                  value="<%= datos?.apellido || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
              </div>

              <!-- DNI -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">DNI</label>
                <input
                  type="text"
                  name="dni"
                  id="dni"
                  placeholder="DNI (8 dígitos)"
                  required
                  maxlength="8"
                  inputmode="numeric"
                  value="<%= datos?.dni || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
                <p class="text-xs text-slate-400">Solo números, 8 dígitos.</p>
              </div>

              <!-- Dirección -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">Dirección</label>
                <input
                  type="text"
                  name="direccion"
                  id="direccion"
                  placeholder="Dirección"
                  required
                  value="<%= datos?.direccion || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
              </div>

              <!-- Teléfono -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">Teléfono</label>
                <input
                  type="text"
                  name="telefono"
                  id="telefono"
                  placeholder="Teléfono"
                  inputmode="numeric"
                  value="<%= datos?.telefono || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
              </div>

              <!-- Email -->
              <div class="space-y-1">
                <label class="block text-sm font-medium text-slate-300">Correo electrónico</label>
                <input
                  type="email"
                  name="email"
                  id="email"
                  placeholder="correo@ejemplo.com"
                  value="<%= datos?.email || '' %>"
                  class="w-full px-4 py-3 rounded-xl
                         bg-slate-900 text-white placeholder-white/35
                         border border-slate-600
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition"
                />
              </div>

            </div>

            <!-- ✅ Activo/Inactivo -->
            <div class="rounded-xl border border-slate-700/70 bg-slate-900/40 p-4">
              <div class="flex items-start gap-3">
                <input
                  id="activo"
                  name="activo"
                  type="checkbox"
                  class="mt-1 h-4 w-4 accent-sky-500"
                  <%= (datos && (datos.activo === false || datos.activo === 'false' || datos.activo === 'off')) ? '' : 'checked' %>
                />
                <div>
                  <label for="activo" class="text-sm font-semibold text-slate-100">
                    Cliente activo
                  </label>
                  <p class="text-xs text-slate-400 mt-0.5">
                    Si está inactivo, el generador (manual o cron) no le crea cargos.
                  </p>
                </div>
              </div>
            </div>

            <!-- Plan -->
            <div class="space-y-2">
              <label class="block text-sm font-medium text-slate-300">Seleccionar plan</label>

              <select
                name="plan"
                id="plan"
                required
                onchange="mostrarDetallePlan(this)"
                class="w-full px-4 py-3 rounded-xl
                       bg-slate-900 text-white
                       border border-slate-600
                       focus:outline-none focus:ring-2 focus:ring-sky-500/60
                       transition"
              >
                <option value="">-- Selecciona un plan --</option>
                <% planes.forEach(plan => { %>
                  <option value="<%= plan._id %>" <%= datos?.plan === plan._id.toString() ? 'selected' : '' %>>
                    <%= plan.nombre %> - <%= plan.tipo %>
                  </option>
                <% }) %>
              </select>

              <div id="detalle-plan" class="hidden rounded-xl border border-slate-700/70 bg-slate-900/40 p-4">
                <p class="text-sm text-slate-300">
                  <span class="text-slate-400">Tipo:</span>
                  <span id="tipo-plan" class="text-white font-medium"></span>
                </p>
                <p class="text-sm text-slate-300 mt-1">
                  <span class="text-slate-400">Precio:</span>
                  <span class="text-emerald-300 font-semibold">$<span id="precio-plan"></span></span>
                </p>
              </div>
            </div>

            <!-- Botón -->
            <div class="pt-2 flex justify-center">
              <button
                type="submit"
                class="w-full sm:w-auto bg-sky-600 hover:bg-sky-700 active:bg-sky-800
                       text-white font-semibold px-8 py-3 rounded-xl
                       shadow-md hover:shadow-lg transition"
              >
                Registrar cliente
              </button>
            </div>

          </form>
        </div>
      </div>

    </div>
  </div>
</main>

<script>
  const planes = <%- JSON.stringify(planes) %>;

  function mostrarDetallePlan(select) {
    const id = select.value;
    const plan = planes.find(p => p._id === id);
    const detalleDiv = document.getElementById('detalle-plan');

    if (plan) {
      document.getElementById('tipo-plan').textContent = plan.tipo;
      document.getElementById('precio-plan').textContent = Number(plan.precio).toFixed(2);
      detalleDiv.classList.remove('hidden');
    } else {
      detalleDiv.classList.add('hidden');
    }
  }

  function soloNumeros(input) { input.value = input.value.replace(/\D/g, ''); }

  function capitalizarNombre(input) {
    input.value = input.value.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
  }

  function capitalizarDireccion(input) {
    const v = input.value.trim();
    if (!v) return;
    input.value = v.charAt(0).toUpperCase() + v.slice(1);
  }

  function validarFormulario() {
    const dni = document.getElementById('dni')?.value.trim() || "";
    if (dni.length !== 8) {
      Swal.fire({
        icon: "error",
        title: "DNI inválido",
        text: "El DNI debe tener exactamente 8 números.",
        confirmButtonColor: "#0ea5e9"
      });
      return false;
    }
    return true;
  }

  document.addEventListener("DOMContentLoaded", () => {
    const nombre = document.getElementById("nombre");
    const apellido = document.getElementById("apellido");
    const dni = document.getElementById("dni");
    const direccion = document.getElementById("direccion");
    const telefono = document.getElementById("telefono");
    const email = document.getElementById("email");

    [nombre, apellido, dni, direccion, telefono, email].forEach((input) => {
      if (!input) return;
      const ph = input.placeholder;
      input.addEventListener("focus", () => input.placeholder = "");
      input.addEventListener("blur", () => { if (!input.value.trim()) input.placeholder = ph; });
    });

    nombre?.addEventListener("blur", () => capitalizarNombre(nombre));
    apellido?.addEventListener("blur", () => capitalizarNombre(apellido));
    direccion?.addEventListener("blur", () => capitalizarDireccion(direccion));

    dni?.addEventListener("input", () => soloNumeros(dni));
    telefono?.addEventListener("input", () => soloNumeros(telefono));

    document.querySelectorAll("input").forEach(i => {
      i.addEventListener("blur", () => i.value = i.value.trim());
    });

    const planSelect = document.getElementById("plan");
    if (planSelect?.value) mostrarDetallePlan(planSelect);
  });
</script>
