<main>
  <style>
    .safe-bottom {
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
    }
  </style>

  <!-- SHELL -->
  <div class="flex items-start justify-center min-h-[calc(100vh-200px)] px-2 sm:px-4 py-0 sm:py-5">
    <div class="w-full max-w-full sm:max-w-5xl lg:max-w-7xl xl:max-w-screen-xl mx-auto
             bg-gradient-to-br from-slate-900/95 via-slate-900/90 to-slate-950/95
             backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700/80
             px-4 sm:px-6 md:px-10 py-6 sm:py-8 md:py-10 text-white safe-bottom">

      <!-- HEADER -->
      <header class="mb-6">
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400 mb-2">
          Administración · Clientes
        </p>

        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
              Listado de clientes
            </h1>
            <p class="text-sm text-slate-300 mt-1">
              Gestión general de clientes
            </p>
          </div>

          <div class="flex gap-2">
            <form action="/clientes/generar-cargos" method="POST"
              onsubmit="return confirm('¿Generar cargos SOLO para clientes ACTIVOS?')">
              <button class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-4 py-2 rounded-xl">
                Generar cargos
              </button>
            </form>

            <a href="/clientes/crear"
              class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-2 rounded-xl">
              Nuevo cliente
            </a>
          </div>
        </div>

        <!-- BUSCADOR -->
        <div class="mt-4 bg-slate-900/40 border border-slate-700/70 rounded-xl p-3">
          <form method="GET" action="/clientes/dashboard" class="grid grid-cols-1 sm:grid-cols-12 gap-2 items-end">

            <div class="sm:col-span-7">
              <label class="text-[11px] text-slate-400">Buscar</label>
              <input type="text" name="q" value="<%= q || '' %>" placeholder="DNI / Nombre / Apellido"
                class="w-full px-3 py-2 rounded-lg bg-slate-950/40 border border-slate-700 text-sm text-white" />
            </div>

            <div class="sm:col-span-3">
              <label class="text-[11px] text-slate-400">Estado</label>
              <select name="estado"
                class="w-full px-3 py-2 rounded-lg bg-slate-950/40 border border-slate-700 text-sm text-white">
                <option value="todos" <%= (!estado || estado === 'todos') ? 'selected' : '' %>>Todos</option>
                <option value="activos" <%= estado === 'activos' ? 'selected' : '' %>>Activos</option>
                <option value="inactivos" <%= estado === 'inactivos' ? 'selected' : '' %>>Inactivos</option>
              </select>
            </div>

            <div class="sm:col-span-2">
              <button class="w-full bg-sky-600 hover:bg-sky-700 text-white py-2 rounded-lg text-sm">
                Buscar
              </button>
            </div>
          </form>

          <% if (q || (estado && estado !== 'todos')) { %>
            <div class="mt-2">
              <a
                href="/clientes/dashboard"
                class="inline-flex items-center bg-slate-950/35 hover:bg-slate-950/55
                       border border-slate-700/70 text-slate-200 font-semibold px-3 py-1.5 rounded-lg text-xs transition"
              >
                Limpiar
              </a>
            </div>
          <% } %>
        </div>
      </header>

      <% if (!clientes || clientes.length === 0) { %>
        <p class="text-center text-slate-300">No hay clientes cargados</p>
      <% } else { %>

        <!-- ================= MOBILE ================= -->
        <section class="space-y-2 sm:hidden">
          <% clientes.forEach(cliente => {
            const esActivo = !(cliente.activo === false || cliente.activo === 'false');
            const accion = esActivo ? 'Desactivar' : 'Activar';
            const accionOk = esActivo ? 'DESACTIVADO' : 'ACTIVADO';

            const precio = Number(cliente.plan?.precio || 0);
            const precioFmt = precio.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          %>

            <!-- Card con borde por estado -->
            <article class="bg-slate-900/60 border rounded-xl p-3 <%= esActivo ? 'border-emerald-500/40' : 'border-rose-500/40' %>">

              <!-- TOP -->
              <div class="flex justify-between gap-2">
                <div class="min-w-0">
                  <p class="text-sm font-semibold truncate">
                    <%= cliente.apellido %>, <%= cliente.nombre %>
                  </p>
                  <p class="text-[11px] text-slate-300">
                    DNI <b><%= cliente.dni %></b>
                  </p>
                </div>

                <div class="shrink-0 text-right">
                  <span class="text-[9px] px-1.5 py-0.5 rounded border
                    <%= esActivo
                      ? 'bg-emerald-500/15 text-emerald-200 border-emerald-400/30'
                      : 'bg-rose-500/15 text-rose-200 border-rose-400/30' %>">
                    <%= esActivo ? 'Activo' : 'Inactivo' %>
                  </span>
                </div>
              </div>

              <!-- PLAN + IMPORTE -->
              <p class="mt-1 text-[11px] text-slate-300 truncate">
                <span class="text-slate-400">Plan:</span>
                <span class="text-sky-200 font-semibold ml-1">
                  <%= cliente.plan?.nombre || '—' %>
                </span>
                <span class="mx-1 text-slate-500">·</span>
                <span class="text-emerald-200 font-semibold">
                  $ <%= precioFmt %>
                </span>
              </p>

              <!-- ACCIONES (altura igual) -->
              <div class="mt-2 grid grid-cols-4 gap-1.5">
                <a
                  href="/clientes/<%= cliente._id %>/historial"
                  class="inline-flex items-center justify-center h-7 px-1
                         text-[10px] leading-none whitespace-nowrap
                         rounded bg-emerald-500/15 text-emerald-200
                         border border-emerald-400/30"
                >
                  Ver
                </a>

                <a
                  href="/clientes/editar/<%= cliente._id %>"
                  class="inline-flex items-center justify-center h-7 px-1
                         text-[10px] leading-none whitespace-nowrap
                         rounded bg-slate-950/40 text-sky-200
                         border border-slate-700"
                >
                  Editar
                </a>

                <form action="/clientes/<%= cliente._id %>/toggle-activo" method="POST">
                  <button
                    type="submit"
                    onclick="return confirmarToggleCliente('<%= accion %>','<%= accionOk %>')"
                    class="w-full inline-flex items-center justify-center h-7 px-1
                           text-[10px] leading-none whitespace-nowrap
                           rounded border
                           <%= esActivo
                             ? 'bg-emerald-500/15 text-emerald-200 border-emerald-400/30'
                             : 'bg-rose-500/15 text-rose-200 border-rose-400/30' %>"
                  >
                    <%= esActivo ? 'On' : 'Off' %>
                  </button>
                </form>

                <form action="/clientes/eliminar/<%= cliente._id %>" method="POST">
                  <button
                    type="submit"
                    onclick="return confirm('¿Eliminar cliente?')"
                    class="w-full inline-flex items-center justify-center h-7 px-1
                           text-[10px] leading-none whitespace-nowrap
                           rounded bg-rose-500/15 text-rose-200
                           border border-rose-400/30"
                  >
                    Eliminar
                  </button>
                </form>
              </div>

            </article>
          <% }) %>
        </section>

        <!-- ================= DESKTOP ================= -->
        <div class="hidden sm:block overflow-x-auto">
          <table class="w-full text-sm bg-slate-900/50 border border-slate-700/70 rounded-xl">
            <thead class="bg-slate-900/70 text-slate-300">
              <tr>
                <th class="px-3 py-2 text-left">Apellido</th>
                <th class="px-3 py-2 text-left">Nombre</th>
                <th class="px-3 py-2">DNI</th>
                <th class="px-3 py-2">Plan</th>
                <th class="px-3 py-2 text-right">Precio</th>
                <th class="px-3 py-2">Estado</th>
                <th class="px-3 py-2 text-right">Acciones</th>
              </tr>
            </thead>

            <tbody>
              <% clientes.forEach(cliente => {
                const esActivo = !(cliente.activo === false || cliente.activo === 'false');
                const accion = esActivo ? 'Desactivar' : 'Activar';
                const accionOk = esActivo ? 'DESACTIVADO' : 'ACTIVADO';

                const precio = Number(cliente.plan?.precio || 0);
                const precioFmt = precio.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              %>
                <tr class="border-t border-slate-700/70 hover:bg-slate-900/40">
                  <td class="px-3 py-2"><%= cliente.apellido %></td>
                  <td class="px-3 py-2"><%= cliente.nombre %></td>
                  <td class="px-3 py-2"><%= cliente.dni %></td>
                  <td class="px-3 py-2"><%= cliente.plan?.nombre || '—' %></td>
                  <td class="px-3 py-2 text-right text-emerald-200 font-semibold">$ <%= precioFmt %></td>

                  <td class="px-3 py-2">
                    <span class="text-xs px-2 py-1 rounded border
                      <%= esActivo
                        ? 'bg-emerald-500/15 text-emerald-200 border-emerald-400/30'
                        : 'bg-rose-500/15 text-rose-200 border-rose-400/30' %>">
                      <%= esActivo ? 'Activo' : 'Inactivo' %>
                    </span>
                  </td>

                  <td class="px-3 py-2 text-right space-x-2">
                    <a href="/clientes/<%= cliente._id %>/historial" class="text-emerald-300 text-xs hover:underline">Ver</a>
                    <a href="/clientes/editar/<%= cliente._id %>" class="text-sky-300 text-xs hover:underline">Editar</a>

                    <form action="/clientes/<%= cliente._id %>/toggle-activo" method="POST" class="inline">
                      <button
                        type="submit"
                        onclick="return confirmarToggleCliente('<%= accion %>','<%= accionOk %>')"
                        class="text-xs px-2 py-1 rounded border
                          <%= esActivo
                            ? 'bg-rose-500/15 text-rose-200 border-rose-400/30'
                            : 'bg-emerald-500/15 text-emerald-200 border-emerald-400/30' %>">
                        <%= esActivo ? 'Desactivar' : 'Activar' %>
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <!-- ================= PAGINACIÓN ================= -->
        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
          <%
            const qs = (p) => {
              const params = new URLSearchParams();
              if (q) params.set('q', q);
              if (estado) params.set('estado', estado);
              if (limit) params.set('limit', String(limit));
              params.set('page', String(p));
              return `/clientes/dashboard?${params.toString()}`;
            };

            const current = Number(page || 1);
            const prevPage = Math.max(current - 1, 1);
            const nextPage = Math.min(current + 1, totalPages);

            const win = 2;
            const start = Math.max(1, current - win);
            const end = Math.min(totalPages, current + win);
          %>

          <nav class="mt-6 flex items-center justify-between gap-2">
            <% if (current > 1) { %>
              <a href="<%= qs(prevPage) %>"
                 class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold
                        bg-slate-950/40 hover:bg-slate-950/60 border border-slate-700/70 text-slate-200 transition">
                ← Anterior
              </a>
            <% } else { %>
              <span class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold
                           bg-slate-950/20 border border-slate-800/70 text-slate-500 cursor-not-allowed">
                ← Anterior
              </span>
            <% } %>

            <div class="flex items-center gap-1">
              <% if (start > 1) { %>
                <a href="<%= qs(1) %>"
                   class="px-2.5 py-2 rounded-lg text-xs font-semibold border border-slate-700/70
                          bg-slate-950/30 hover:bg-slate-950/55 text-slate-200 transition">1</a>
                <% if (start > 2) { %>
                  <span class="px-2 text-slate-500 text-xs">…</span>
                <% } %>
              <% } %>

              <% for (let p = start; p <= end; p++) { %>
                <% if (p === current) { %>
                  <span class="px-2.5 py-2 rounded-lg text-xs font-extrabold
                               bg-sky-600/30 border border-sky-400/40 text-white">
                    <%= p %>
                  </span>
                <% } else { %>
                  <a href="<%= qs(p) %>"
                     class="px-2.5 py-2 rounded-lg text-xs font-semibold border border-slate-700/70
                            bg-slate-950/30 hover:bg-slate-950/55 text-slate-200 transition">
                    <%= p %>
                  </a>
                <% } %>
              <% } %>

              <% if (end < totalPages) { %>
                <% if (end < totalPages - 1) { %>
                  <span class="px-2 text-slate-500 text-xs">…</span>
                <% } %>
                <a href="<%= qs(totalPages) %>"
                   class="px-2.5 py-2 rounded-lg text-xs font-semibold border border-slate-700/70
                          bg-slate-950/30 hover:bg-slate-950/55 text-slate-200 transition">
                  <%= totalPages %>
                </a>
              <% } %>
            </div>

            <% if (current < totalPages) { %>
              <a href="<%= qs(nextPage) %>"
                 class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold
                        bg-slate-950/40 hover:bg-slate-950/60 border border-slate-700/70 text-slate-200 transition">
                Siguiente →
              </a>
            <% } else { %>
              <span class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-semibold
                           bg-slate-950/20 border border-slate-800/70 text-slate-500 cursor-not-allowed">
                Siguiente →
              </span>
            <% } %>
          </nav>

          <p class="mt-2 text-xs text-slate-400">
            Página <b class="text-slate-200"><%= Number(page || 1) %></b> de <b class="text-slate-200"><%= totalPages %></b>
            · Total: <b class="text-slate-200"><%= total %></b>
          </p>
        <% } %>

      <% } %>

    </div>
  </div>

  <script>
    function confirmarToggleCliente(accion, accionOk) {
      if (!confirm(`¿${accion} este cliente?`)) return false;
      alert(`Cliente ${accionOk} correctamente`);
      return true;
    }
  </script>
</main>
