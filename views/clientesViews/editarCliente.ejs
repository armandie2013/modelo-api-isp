<main>
  <style>
    .safe-bottom {
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
    }
  </style>

  <div class="flex items-start justify-center min-h-[calc(100vh-200px)] px-2 sm:px-4 py-0 sm:py-5">
    <div class="w-full max-w-full sm:max-w-5xl lg:max-w-7xl xl:max-w-screen-xl mx-auto
             bg-gradient-to-br from-slate-900/95 via-slate-900/90 to-slate-950/95
             backdrop-blur-md rounded-2xl shadow-2xl border border-slate-700/80
             px-4 sm:px-6 md:px-10 py-6 sm:py-8 md:py-10 text-white safe-bottom">

      <!-- Header -->
      <header class="mb-5 sm:mb-8">
        <p class="text-[10px] sm:text-xs uppercase tracking-[0.25em] text-slate-400 mb-2">
          Administración · Clientes
        </p>

        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div class="min-w-0">
            <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">
              Editar cliente
            </h1>
            <p class="text-sm text-slate-300 mt-1 max-w-2xl">
              Actualizá los datos del cliente y seleccioná el plan correspondiente.
            </p>
          </div>

          <a href="/clientes/dashboard" class="inline-flex items-center justify-center
                   bg-slate-950/40 hover:bg-slate-950/60
                   border border-slate-700/70
                   text-slate-200 font-semibold
                   px-3 py-2 rounded-xl text-xs sm:text-sm
                   transition whitespace-nowrap">
            Volver al listado
          </a>
        </div>
      </header>

      <!-- Card -->
      <div class="flex justify-center">
        <div class="w-full max-w-2xl bg-slate-900/45 border border-slate-700/70 rounded-2xl shadow-lg">

          <div class="px-4 sm:px-6 py-3 border-b border-slate-700/60">
            <p class="text-xs text-slate-400">
              Revisá los datos antes de guardar. Si lo dejás inactivo, no se generan cargos.
            </p>
          </div>

          <div class="p-4 sm:p-6">
            <form action="/clientes/editar/<%= cliente._id %>" method="POST" class="space-y-5">

              <!-- Datos -->
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">

                <div class="space-y-1">
                  <label class="block text-sm font-medium text-slate-300" for="nombre">Nombre</label>
                  <input type="text" id="nombre" name="nombre" placeholder="Nombre" required
                    value="<%= cliente.nombre %>" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                </div>

                <div class="space-y-1">
                  <label class="block text-sm font-medium text-slate-300" for="apellido">Apellido</label>
                  <input type="text" id="apellido" name="apellido" placeholder="Apellido" required
                    value="<%= cliente.apellido %>" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                </div>

                <div class="space-y-1">
                  <label class="block text-sm font-medium text-slate-300" for="dni">DNI</label>
                  <input type="text" id="dni" name="dni" placeholder="DNI" required value="<%= cliente.dni %>"
                    inputmode="numeric" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                  <p class="text-[11px] text-slate-400">Solo números.</p>
                </div>

                <div class="space-y-1">
                  <label class="block text-sm font-medium text-slate-300" for="telefono">Teléfono</label>
                  <input type="text" id="telefono" name="telefono" placeholder="Teléfono"
                    value="<%= cliente.telefono || '' %>" inputmode="numeric" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                </div>

                <div class="space-y-1 sm:col-span-2">
                  <label class="block text-sm font-medium text-slate-300" for="direccion">Dirección</label>
                  <input type="text" id="direccion" name="direccion" placeholder="Dirección" required
                    value="<%= cliente.direccion %>" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                </div>

                <div class="space-y-1 sm:col-span-2">
                  <label class="block text-sm font-medium text-slate-300" for="email">Correo electrónico</label>
                  <input type="email" id="email" name="email" placeholder="correo@ejemplo.com"
                    value="<%= cliente.email || '' %>" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                           bg-slate-950/40 text-white placeholder-white/35
                           border border-slate-700
                           focus:outline-none focus:ring-2 focus:ring-sky-500/60
                           transition text-sm" />
                </div>

              </div>

              <!-- ✅ Activo/Inactivo -->
              <div class="rounded-xl border border-slate-700/70 bg-slate-950/30 p-3 sm:p-4">
                <div class="flex items-start gap-3">
                  <input id="activo" name="activo" type="checkbox" class="mt-0.5 h-4 w-4 accent-sky-500"
                    <%= (cliente.activo === false || cliente.activo === 'false') ? '' : 'checked' %>
                  />
                  <div class="min-w-0">
                    <label for="activo" class="text-sm font-semibold text-slate-100">
                      Cliente activo
                    </label>
                    <p class="text-[11px] sm:text-xs text-slate-400 mt-0.5">
                      Si está inactivo, el generador (manual o cron) no le crea cargos.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Plan -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-slate-300" for="plan">Seleccionar plan</label>

                <select name="plan" id="plan" required onchange="mostrarDetallePlan(this)" class="w-full px-3 sm:px-4 py-2.5 sm:py-3 rounded-xl
                         bg-slate-950/40 text-white
                         border border-slate-700
                         focus:outline-none focus:ring-2 focus:ring-sky-500/60
                         transition text-sm">
                  <option value="">-- Seleccioná un plan --</option>
                  <% planes.forEach(plan => { %>
                    <option value="<%= plan._id %>" <%= cliente.plan?.toString() === plan._id.toString() ? 'selected' : '' %>>
                      <%= plan.nombre %> - <%= plan.tipo %>
                    </option>
                  <% }) %>
                </select>

                <div id="detalle-plan" class="hidden rounded-xl border border-slate-700/70 bg-slate-950/30 p-4">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <p class="text-[11px] text-slate-400">Tipo</p>
                      <p id="tipo-plan" class="text-white font-semibold text-sm"></p>
                    </div>

                    <div class="text-right">
                      <p class="text-[11px] text-slate-400">Precio</p>
                      <p class="text-emerald-300 font-extrabold text-lg leading-tight">
                        <span>$</span><span id="precio-plan"></span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ✅ Acciones -->
              <div class="pt-1">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 w-full sm:w-auto sm:justify-end sm:ml-auto">
                  <button type="submit" class="w-full sm:w-auto
                       bg-sky-600 hover:bg-sky-700 active:bg-sky-800
                       text-white font-semibold
                       px-8 py-3 rounded-xl
                       shadow-md hover:shadow-lg transition">
                    Guardar cambios
                  </button>

                  <a href="/clientes/dashboard" class="w-full sm:w-auto
                       bg-slate-950/40 hover:bg-slate-950/60
                       border border-slate-700/70
                       text-slate-200 font-semibold
                       px-8 py-3 rounded-xl
                       transition text-center">
                    Cancelar
                  </a>
                </div>
              </div>

            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</main>

  <!-- ✅ JSON seguro para JS (evita errores de línea y de EJS dentro de JS) -->
  <script type="application/json" id="planes-json">
    <%- JSON.stringify(planes || []) %>
  </script>

  <script>
    // ✅ Lee JSON desde el script type=application/json
    const planes = JSON.parse(document.getElementById("planes-json")?.textContent || "[]");
    const planSeleccionado = "<%= cliente.plan?.toString() || '' %>";

    function moneyARS(value) {
      const n = Number(value || 0);
      return n.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function mostrarDetallePlan(select) {
      const id = select.value;
      const plan = planes.find(p => String(p._id) === String(id));
      const detalleDiv = document.getElementById("detalle-plan");

      if (plan) {
        document.getElementById("tipo-plan").textContent = plan.tipo || "—";
        document.getElementById("precio-plan").textContent = moneyARS(plan.precio);
        detalleDiv.classList.remove("hidden");
      } else {
        detalleDiv.classList.add("hidden");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Placeholders: focus borra, blur vuelve si está vacío
      const inputs = Array.from(document.querySelectorAll("input[placeholder]"));
      inputs.forEach((input) => {
        const ph = input.placeholder;
        input.addEventListener("focus", () => input.placeholder = "");
        input.addEventListener("blur", () => {
          if (!input.value.trim()) input.placeholder = ph;
        });
      });

      // DNI y teléfono solo números
      const dni = document.getElementById("dni");
      const tel = document.getElementById("telefono");
      dni?.addEventListener("input", function () { this.value = this.value.replace(/\D/g, "").slice(0, 10); });
      tel?.addEventListener("input", function () { this.value = this.value.replace(/\D/g, "").slice(0, 15); });

      // Mostrar detalle plan inicial
      const planSelect = document.getElementById("plan");
      if (planSelect && planSeleccionado) {
        planSelect.value = planSeleccionado;
        mostrarDetallePlan(planSelect);
      }
    });
  </script>
